# 预处理

## 一、预处理命令是什么？

在编译之前对源文件进行简单加工的过程，就称为**预处理**（即预先处理、提前处理）。

预处理主要是处理以`#`开头的命令，例如`#include <stdio.h>`等。预处理命令要放在所有函数之外，而且一般都放在源文件的前面。

预处理是C语言的一个重要功能，由**预处理程序**完成。当对一个源文件进行编译时，系统将自动调用预处理程序对源程序中的预处理部分作处理，处理完毕自动进入对源程序的编译。

编译器会将预处理的结果保存到和源文件同名的`.i`文件中，例如 main.c 的预处理结果在 main.i 中。和`.c`一样，`.i`也是文本文件，可以用编辑器打开直接查看内容。

C语言提供了多种预处理功能，如宏定义、文件包含、条件编译等，合理地使用它们会使编写的程序便于阅读、修改、移植和调试，也有利于模块化程序设计。

## 二、#include的用法

`#include`叫做文件包含命令，用来引入对应的头文件（`.h`文件）。#include 也是C语言预处理命令的一种。

\#include 的处理过程很简单，就是将头文件的内容插入到该命令所在的位置，从而把头文件和当前源文件连接成一个源文件，这与复制粘贴的效果相同。

\#include 的用法有两种，如下所示：

```c
#include <stdHeader.h>
#include "myHeader.h"
```

使用尖括号`< >`和双引号`" "`的区别在于头文件的搜索路径不同：

- 使用尖括号`< >`，编译器会到系统路径下查找头文件；
- 而使用双引号`" "`，编译器首先在当前目录下查找头文件，如果没有找到，再到系统路径下查找。


也就是说，使用双引号比使用尖括号多了一个查找路径，它的功能更为强大。

前面我们一直使用尖括号来引入标准头文件，现在我们也可以使用双引号了，如下所示：

```
#include "stdio.h"
#include "stdlib.h"
```

stdio.h 和 stdlib.h 都是标准头文件，它们存放于系统路径下，所以使用尖括号和双引号都能够成功引入；而我们自己编写的头文件，一般存放于当前项目的路径下，所以不能使用尖括号，只能使用双引号。

**习惯是使用尖括号来引入标准头文件，使用双引号来引入自定义头文件（自己编写的头文件）**

关于 #include 用法的注意事项：

- 一个 #include 命令只能包含一个头文件，多个头文件需要多个 #include 命令。
- 同一个头文件可以被多次引入，多次引入的效果和一次引入的效果相同，因为头文件在代码层面有防止重复引入的机制
- 文件包含允许嵌套，也就是说在一个被包含的文件中又可以包含另一个文件。

```c
// my.h
//声明函数
int sum(int m, int n);

// my.c
//计算从m加到n的和
int sum(int m, int n) {
  return m + n;
}

// main.c
#include <stdio.h>
#include "my.h"
int main() {
    printf("%d\n", sum(1, 2));
    return 0;
}
```



```bash
$ tree .

.
├── main.c
├── my.c
└── my.h

$ gcc my.c main.c -o a.out
$ ./a.out
```

## 三、宏定义 #define

\#define 叫做宏定义命令，它也是C语言预处理命令的一种。

所谓宏定义，就是用一个标识符来表示一个字符串，如果在后面的代码中出现了该标识符，那么就全部替换成指定的字符串。

```c
#include <stdio.h>

#define N 100

int main(){
    int sum = 20 + N;
    printf("%d\n", sum);
    return 0;
}
// 120
```

`#define N 100`就是宏定义，`N`为宏名，`100`是宏的内容（宏所表示的字符串）。在预处理阶段，对程序中所有出现的“宏名”，预处理器都会用宏定义中的字符串去代换，这称为“宏替换”或“宏展开”。

宏定义是由源程序中的宏定义命令`#define`完成的，宏替换是由预处理程序完成的。

宏定义的一般形式为：

```c
#define 宏名 字符串
```

`#`表示这是一条预处理命令，所有的预处理命令都以 # 开头。`宏名`是标识符的一种，命名规则和变量相同。`字符串`可以是数字、表达式、if 语句、函数等。

程序中反复使用的表达式就可以使用宏定义，例如：

```c
#include <stdio.h>

#define M (n * n + 1)

int main() {
  int n = 2;
  int a = 2 * M;
  printf("%d\n", a);

  return 0;
}
```

需要注意的是，在宏定义中表达式`(n*n+3*n)`两边的括号不能少，否则在宏展开以后可能会产生歧义。

**对 #define 用法的几点说明**

- 宏定义是用宏名来表示一个字符串，在宏展开时又以该字符串取代宏名，这只是一种简单粗暴的替换。字符串中可以含任何字符，它可以是常数、表达式、if 语句、函数等，预处理程序对它不作任何检查，如有错误，只能在编译已被宏展开后的源程序时发现。
-  宏定义不是说明或语句，在行末不必加分号，如加上分号则连分号也一起替换。
- 宏定义必须写在函数之外，其作用域为宏定义命令起到源程序结束。如要终止其作用域可使用`#undef`命令。例如：

表示 PI 只在 main() 函数中有效，在 func() 中无效。

```c
#define PI 3.14159
int main(){
    // Code
    return 0;
}
#undef PI
void func(){
    // Code
}
```

- 代码中的宏名如果被引号包围，那么预处理程序不对其作宏代替，例如：

```c
#include <stdio.h>
#define OK 100
int main(){
    printf("OK\n");
    return 0;
}
```

- 宏定义允许嵌套，在宏定义的字符串中可以使用已经定义的宏名，在宏展开时由预处理程序层层代换。例如：

```c
#define PI 3.1415926
#define S PI*y*y    /* PI是已定义的宏名*/
```

对语句，在宏代换后变为：

```c
printf("%f", S);
printf("%f", 3.1415926*y*y);
```

- 习惯上宏名用大写字母表示，以便于与变量区别。但也允许用小写字母。
-  可用宏定义表示数据类型，使书写方便。例如：

```c
#define UINT unsigned int
```

在程序中可用 UINT 作变量说明：

```c
UINT a, b;
```

应注意用宏定义表示数据类型和用 [typedef](http://m.biancheng.net/cpp/html/100.html) 定义数据说明符的区别。**宏定义只是简单的字符串替换，由预处理器来处理；而 typedef 是在编译阶段由编译器处理的，它并不是简单的字符串替换，而给原有的数据类型起一个新的名字，将它作为一种新的数据类型**。

请看下面的例子：

```c
#define PIN1 int *
typedef int *PIN2;  //也可以写作typedef int (*PIN2);
```

从形式上看这两者相似， 但在实际使用中却不相同。

下面用 PIN1，PIN2 说明变量时就可以看出它们的区别：

```c
PIN1 a, b;
```

在宏代换后变成：

```c
int * a, b;
```

表示 a 是指向整型的指针变量，而 b 是整型变量。然而：

```c
PIN2 a,b;
```

表示 a、b 都是指向整型的指针变量。因为 PIN2 是一个新的、完整的数据类型。由这个例子可见，**宏定义虽然也可表示数据类型， 但毕竟只是简单的字符串替换。在使用时要格外小心，以避出错**。

## 四、带参数的宏定义

