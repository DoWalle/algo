# 理解并发程序执行

## Overview

复习

- 并发程序 = 多个执行流、共享内存的状态机

------

本次课回答的问题

- **Q**: 如何阅读理解教科书/互联网/期末试卷上的各种并发程序？

------

本次课主要内容

- (自动) 画状态机理解并发程序

## 一、画状态机理解并发程序

### 1、一个互斥算法

> 互斥：保证两个线程不能同时执行一段代码。

插入 “神秘代码”，使得 [sum.c](http://jyywiki.cn/pages/OS/2022/demos/sum.c) (或者任意其他代码) 能够正常工作

```c
void Tsum() {
  // 神秘代码
  sum++;
  // 神秘代码
}
```

- 假设一个内存的读/写可以保证顺序、原子完成

```c
__sync_synchronize();
x = 1; // 或 int t = x;
__sync_synchronize();
```

---

```c
#include "thread.h"

#define N 100000000

long sum = 0;

void Tsum() {
    for (int i = 0; i < N; i++) {
        sum++;
    }
}

int main() {
    create(Tsum);
    create(Tsum);
    join();
    printf("sum = %ld\n", sum);
}
```

```bash
$ gcc -O0 a.c && ./a.out 
sum = 101852382
$ gcc -O1 a.c && ./a.out 
sum = 200000000
$ gcc -O2 a.c && ./a.out 
sum = 200000000
```

通过：objdump 命令去看

```bash
$ gcc -O0 -c a.c && objdump -d a.o
$ gcc -O1 -c a.c && objdump -d a.o
```

