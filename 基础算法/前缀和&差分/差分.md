
# 差分

参考：[https://oi-wiki.org/basic/prefix-sum/](https://oi-wiki.org/basic/prefix-sum/)

差分是一种和前缀和相对的策略，可以当做是求和的逆运算。

**应用：看到一个区间的统一变化，果断想能不能用差分**

差分数组可由前缀和数组算出：
$$
diff[i] = 
\begin{cases}
preSum[i]-preSum[i-1] & i>1 \\
preSum[i] & i=0
\end{cases}
$$

则差分数组从0累加到第n项，也是第n项前缀和为：

$$
\begin{align}
\sum\limits_{i=0}^{n}diff[i] &= preSum[0] + preSum[1]-preSum[0] + ...+preSum[n] - preSum[n-1] \\
&= preSum[n]
\end{align}
$$

## 差分数组的性质

对**差分数组内区间两端**进行操作以代替**前缀和数组内整个区间**的操作，**时间复杂度从O(k)降至O(1)）**

一个区间`[i, i+k-1]`，区间长度为`k`

在差分数组内区间首元素`diff[i]`加上变化量`△`，区间尾元素的下一位`diff[i+k]`减上变化量`△`，就可以算出差分数组。

在初始化差分数组时长度要设为 `sz+△`，防止数组越界。
$$
\begin{cases} diff[i]+\triangle \\ 
diff[i+k]-\triangle 
\end{cases}
$$

应用前缀和公式，就可以算出前缀和数组
$$
pre\_sum[i] = pre\_sum[i-1]+diff[i]
$$

例如：
有个数组 `requests = [[1,3],[0,1]]` 每个元素描述：在原数组 `nums = [1,2,3,4,5]` 区间 `[start,end]` 内都会加上变化量 `△=2`

最后输出原数组变化后的样子。采用差分算法的时间复杂度为 `O(n)`，采用普通的方法为 `O(n*k)`，k为区间长度。

```
sz = len(nums)
# 差分数组，注意将差分数组的长度扩充变化量 2
diff = [0 for _ in range(sz+2)]
for start, end in requests:
    diff[start] += 2
    diff[end+1] -= 2
print(diff) # [2, 2, -2, 0, -2, 0, 0]

# 通过差分数组推出前缀和数组，前缀和描述了原数组每个位置的变化量
pre_sum = [0 for _ in range(sz+1)]
for i in range(sz):
    pre_sum[i+1] = pre_sum[i] + diff[i]
print(pre_sum) # [0, 2, 4, 2, 2, 0]

for i in range(sz):
    nums[i] += pre_sum[i+1]
print(nums) # [3, 6, 5, 6, 5] 
```
```
nums = [1,2,3,4,5]
requests = [[1,3],[0,1]]
for start, end in requests:
    for i in range(start, end+1):
        nums[i] += 2
print(nums) # [3, 6, 5, 6, 5]
```

**证明**

前缀和数组preSum在区间长度为 k 的 [i, i+k-1] 范围内的元素都加一

可以看出差分数组区间内的首元素加一 `diff[i]+1`，末元素的下一位减一 `diff[i+k]-1`

| preSum(原来)   | diff(原来)                  | preSum(加一后)      | diff(加一后)                                |
| -------------- | --------------------------- | ------------------- | ------------------------------------------- |
| preSum[i-1]    | preSum[i-1]-preSum[i-2]     | preSum[i-1]         | preSum[i-1]-preSum[i-2]=diff[i-1]           |
| preSum[i]      | preSum[i]-preSum[i-1]       | **preSum[i]+1**     | **preSum[i]+1-preSum[i-1]=diff[i]+1**       |
| preSum[i+1]    | preSum[i+1]-preSum[i]       | **preSum[i+1]+1**   | preSum[i+1]+1-preSum[i]-1=diff[i+1]         |
| ...            | ...                         | ...                 | ...                                         |
| preSum[ i+k-2] | preSum[i+k-2]-preSum[i+k-3] | **preSum[i+k-2]+1** | preSum[i+k-2]+1-preSum[i+k-3]+1=diff[i+k-2] |
| preSum[ i+k-1] | preSum[i+k-1]-preSum[i+k-2] | **preSum[i+k-1]+1** | preSum[i+k-1]+1-preSum[i+k-2]+1=diff[i+k-1] |
| preSum[ i+k]   | preSum[i+k]-preSum[i+k-1]   | preSum[i+k**]**     | **preSum[i+k]-preSum[i+k-1]+1=diff[i+k]-1** |

前缀和数组内区间元素整体加一，而在差分数组内区间只是两端变化（首元素加一，末元素的下一位减一）

## 例题

[1109-[差分]-航班预订统计](./例题/1109-[差分]-航班预订统计.md)

[995-[差分数组]-K 连续位的最小翻转次数](./例题/995-[差分数组]-K 连续位的最小翻转次数.md)


